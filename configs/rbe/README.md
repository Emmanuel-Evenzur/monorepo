This directory contains configurations generated by [`rbe_configs_gen`](https://github.com/bazelbuild/bazel-toolchains).

`rbe_configs_gen` works by running Bazel inside a container to auto-detect toolchains available in that container. The
detected toolchains are saved to this directory. When building remotely with RBE, we override Bazel's toolchains with
what we detected previously and tell RBE to run actions inside that container.

## Directory structure

```
configs/rbe
 |
 |-- rbe_ubuntu1604_java8    # The generated configuration for --config=ubuntu1604_java8
 |-- rbe_ubuntu1804_java11   # The generated configuration for --config=ubuntu1804_java11
 |-- cpp_env_ubuntu1604.json # Environment variables to be set when generating C++ configs for --config=ubuntu1604_java8
 |-- cpp_env_ubuntu1804.json # Environment variables to be set when generating C++ configs for --config=ubuntu1804_java11
 |-- gen.sh                  # The script used to generate rbe_ubuntu_1604_java8 and rbe_ubuntu_1804_java11
```

## Generation

To (re)generate `rbe_ubuntu1604_java8` and `rbe_ubuntu1804_java11`:

1. Make sure `docker` is installed locally.
2. Install [`rbe_configs_gen`](https://github.com/bazelbuild/bazel-toolchains).
3. run the `gen.sh` script:
   ```shell
   ./gen.sh
   ```

## FAQ

### Do we have to do it everytime we publish Docker images?

Yes. The container image which RBE uses to run your build is determined at generation time - it's the same container
used to detect the toolchains. The image used to run your remote actions can be found at
.e.g `rbe_ubuntu1604_java8/config/BUILD`:

```
...
    "container-image": "docker://gcr.io/bazel-public/ubuntu1604-bazel-java8@sha256:135cb1647b54893531bf220001b07ac34bd2963a59af69659257cc1f121c9958",
...
```

### How do we handle Bazel version upgrades?
The same as what you did with `rbe_autoconfig` where you pin the version of `bazel-toolchains` to one that is compatible
with the version you upgrade to. For `rbe_configs_gen`, you just regenerate the configurations with the new version.

For this directory specifically, update the `BAZEL_VERSION` variable in `gen.sh` and rerun the script.